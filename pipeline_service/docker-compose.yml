version: '3.8'

services:
  ml-pipeline:
    build: .
    container_name: ml-pipeline-service
    ports:
      - "5002:5002"
    environment:
      - MONGO_URI=mongodb://host.docker.internal:27017/
      - MONGO_DB_NAME=roadrunner_survey
      - UPLOAD_DIR=/app/uploads
      - PORT=5002
      # AWS credentials for SageMaker
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_DEFAULT_REGION=ap-south-1
    volumes:
      # Mount uploads directory (should be same as main backend)
      - ../backend/uploads:/app/uploads
      # Mount pipeline config
      - ../pipeline/endpoint_config.json:/app/endpoint_config.json:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:5002/health', timeout=2)"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s
